<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comments</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9fafb;
        }

        .container {
            max-width: 800px;
            margin: 30px auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            background-color: #4f46e5;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #4338ca;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .comment {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 5px;
            background-color: #f9fafb;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .comment-author {
            font-weight: 600;
        }

        .comment-actions {
            display: flex;
            align-items: center;
        }

        .like-button,
        .dislike-button,
        .heart-button {
            display: flex;
            align-items: center;
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .like-button:hover,
        .dislike-button:hover,
        .heart-button:hover {
            color: #4f46e5;
        }

        .like-button.active,
        .dislike-button.active,
        .heart-button.active {
            color: #4f46e5;
        }

        .icon {
            width: 20px;
            height: 20px;
            margin-right: 5px;
        }

        .delete-button {
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .delete-button:hover {
            color: #ef4444;
        }

        #commentForm {
            margin-top: 20px;
        }

        #commentInput {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 5px;
            resize: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div id="authStatus"></div>
            <div>
                <button id="authButton">Login / Signup</button>
                <button id="logoutButton" style="display: none;">Logout</button>
            </div>
        </div>
        <div id="commentsContainer"></div>
        <form id="commentForm" style="display: none;">
            <textarea id="commentInput" placeholder="Enter your comment (max 100 characters)" maxlength="100"
                rows="3"></textarea>
            <button type="submit">Post Comment</button>
        </form>
    </div>

    <script>
        const pathParts = window.location.pathname.split("/");
        const username = pathParts[pathParts.length - 1];
        const authStatus = document.getElementById("authStatus");
        const authButton = document.getElementById("authButton");
        const logoutButton = document.getElementById("logoutButton");
        const commentForm = document.getElementById("commentForm");
        const commentsContainer = document.getElementById("commentsContainer");
        const commentInput = document.getElementById("commentInput");
        let loggedInUser = null;
        let processingRequest = false;

        const likeIcon = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>';
        const dislikeIcon = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"></path></svg>';
        const heartIcon = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>';
        const deleteIcon = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>';

        function updateUI(loggedIn) {
            authButton.style.display = loggedIn ? "none" : "block";
            logoutButton.style.display = loggedIn ? "block" : "none";
            commentForm.style.display = loggedIn ? "block" : "none";
        }

        function checkLoginStatus() {
            fetch("/api/")
                .then(response => response.json())
                .then(data => {
                    if (data.logged_in) {
                        authStatus.innerText = "Logged in as: " + data.user_id;
                        updateUI(true);
                        loggedInUser = data.user_id;
                    } else {
                        authStatus.innerText = "Not logged in";
                        updateUI(false);
                    }
                    getComments();
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function getComments() {
            fetch(`/api/user/${username}/comments`)
                .then(response => response.json())
                .then(data => {
                    commentsContainer.innerHTML = "";

                    if (data.error) {
                        commentsContainer.innerHTML = `<p>${data.error}</p>`;
                        return;
                    }

                    data.forEach(comment => {
                        const commentElement = document.createElement('div');
                        commentElement.classList.add('comment');

                        const likeButtonClass = comment.is_liked ? 'like-button active' : 'like-button';
                        const dislikeButtonClass = comment.is_disliked ? 'dislike-button active' : 'dislike-button';
                        const heartButtonClass = comment.is_owner_liked ? 'heart-button active' : 'heart-button';

                        const likeButton = loggedInUser && loggedInUser !== comment.author
                            ? `<button class="${likeButtonClass}" ${comment.is_liked ? 'disabled' : ''} onclick="likeComment('${comment.id}', ${comment.is_disliked})">${likeIcon} ${comment.likes}</button>`
                            : `<div class="${likeButtonClass}">${likeIcon} ${comment.likes}</div>`;

                        const dislikeButton = loggedInUser && loggedInUser !== comment.author
                            ? `<button class="${dislikeButtonClass}" ${comment.is_disliked ? 'disabled' : ''} onclick="dislikeComment('${comment.id}', ${comment.is_liked})">${dislikeIcon} ${comment.dislikes}</button>`
                            : `<div class="${dislikeButtonClass}">${dislikeIcon} ${comment.dislikes}</div>`;

                        const heartButton = loggedInUser === username
                            ? `<button class="${heartButtonClass}" onclick="toggleOwnerLike('${comment.id}')">${heartIcon}</button>`
                            : '';

                        const deleteButton = loggedInUser === comment.author
                            ? `<button class="delete-button" onclick="deleteComment('${comment.id}')">${deleteIcon}</button>`
                            : '';

                        commentElement.innerHTML = `
                            <div class="comment-header">
                                <div class="comment-author">${comment.author}</div>
                                <div class="comment-actions">
                                    ${likeButton}
                                    ${dislikeButton}
                                    ${heartButton}
                                    ${deleteButton}
                                </div>
                            </div>
                            <div class="comment-content">${comment.content}</div>
                        `;

                        commentsContainer.appendChild(commentElement);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function createComment(event) {
            event.preventDefault();
            const content = commentInput.value.trim();
            if (!content) {
                return;
            }

            fetch(`/api/user/${username}/comments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: content })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert("Error: " + data.error);
                    } else {
                        getComments();
                        commentInput.value = "";
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        async function deleteComment(commentId) {
            if (!confirm("Are you sure you want to delete this comment?")) {
                return;
            }

            try {
                const response = await fetch(`/api/user/${username}/comments/${commentId}`, {
                    method: 'DELETE',
                });
                const data = await response.json();
                if (data.error) {
                    alert("Error: " + data.error);
                } else {
                    getComments();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function likeComment(commentId, isDisliked) {
            if (isDisliked) {
                await removeDislike(commentId);
            }
            await sendLikeRequest(commentId);
        }

        async function dislikeComment(commentId, isLiked) {
            if (isLiked) {
                await removeLike(commentId);
            }
            await sendDislikeRequest(commentId);
        }

        async function sendLikeRequest(commentId) {
            if (processingRequest) return;
            processingRequest = true;
            try {
                const response = await fetch(`/api/like/like/${commentId}`, {
                    method: 'POST',
                });
                const data = await response.json();
                if (data.error) {
                    alert("Error: " + data.error);
                } else {
                    getComments();
                }
            } catch (error) {
                console.error('Error:', error);
            }
            processingRequest = false;
        }

        async function sendDislikeRequest(commentId) {
            if (processingRequest) return;
            processingRequest = true;
            try {
                const response = await fetch(`/api/like/dislike/${commentId}`, {
                    method: 'POST',
                });
                const data = await response.json();
                if (data.error) {
                    alert("Error: " + data.error);
                } else {
                    getComments();
                }
            } catch (error) {
                console.error('Error:', error);
            }
            processingRequest = false;
        }

        async function removeLike(commentId) {
            if (processingRequest) return;
            processingRequest = true;
            try {
                const response = await fetch(`/api/like/remove-like/${commentId}`, {
                    method: 'POST',
                });
                const data = await response.json();
                if (data.error) {
                    alert("Error: " + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
            }
            processingRequest = false;
        }

        async function removeDislike(commentId) {
            if (processingRequest) return;
            processingRequest = true;
            try {
                const response = await fetch(`/api/like/remove-dislike/${commentId}`, {
                    method: 'POST',
                });
                const data = await response.json();
                if (data.error) {
                    alert("Error: " + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
            }
            processingRequest = false;
        }

        async function toggleOwnerLike(commentId) {
            if (processingRequest) return;
            processingRequest = true;
            try {
                const response = await fetch(`/api/like/toggle-owner-like/${commentId}`, {
                    method: 'POST',
                });
                const data = await response.json();
                if (data.error) {
                    alert("Error: " + data.error);
                } else {
                    getComments();
                }
            } catch (error) {
                console.error('Error:', error);
            }
            processingRequest = false;
        }

        checkLoginStatus();

        commentForm.addEventListener("submit", createComment);

        authButton.addEventListener("click", function () {
            const currentPath = window.location.pathname;
            window.location.href = "/api/auth/login?current=" + encodeURIComponent(currentPath);
        });

        logoutButton.addEventListener("click", function () {
            fetch("/api/auth/logout", {
                method: 'GET'
            })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    window.location.reload();
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });
    </script>
</body>

</html>